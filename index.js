const fs=require("fs"),path=require("path"),JSONStream=require("JSONStream"),meta_parser=require("./metadata_parser"),text_parser=require("./text_parser"),post_meta=require("./post_meta"),beautify=require("./beautify"),use_config=async e=>{let a;try{a=JSON.parse(e)}catch(e){throw new Error("The config.json has some errors:\n"+e)}const t=path.join(__dirname,...a.filepath),r=path.basename(t,path.extname(t)),i=path.dirname(t),s=path.join(i,`${r}.fixed.json`);fs.existsSync(s)?analyzeText(s,a):fs.readFile(t,"utf8",((e,t)=>{if(e)throw e;const r=t.replace(/\x([0-9A-Fa-f]{2})/g,((e,a)=>String.fromCharCode(parseInt(a,16))));fs.writeFile(s,r,"utf8",(e=>{if(e)throw e;analyzeText(s,a)}))}))},analyzeText=(e,a)=>{let t=JSONStream.parse(["chats","list",!0]);t.on("data",(function(e){})),t.on("end",(()=>{})),fs.createReadStream(e).pipe(t)};fs.readFile(path.join(__dirname,"config.json"),(async(e,a)=>{if(e)throw e;await use_config(a)}));